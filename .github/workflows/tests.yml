name: Run Tests

on:
  push:
    branches: [ main, HACS_compilant ]
  pull_request:
    branches: [ main, HACS_compilant ]

jobs:
  test:
    name: Run Integration Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pytest pytest-asyncio
    
    - name: Run simple tests
      run: |
        cd custom_components/eedomus
        python3 ../../scripts/simple_test.py
    
    - name: Test energy sensor (Issue #9)
      run: |
        cd custom_components/eedomus
        echo "Testing energy sensor implementation..."
        python3 -c "
        import os
        with open('sensor.py', 'r') as f:
            content = f.read()
            assert 'energy' in content.lower(), 'Energy not found in sensor.py'
            assert 'consumption' in content.lower(), 'Consumption not found in sensor.py'
            assert 'usage_id' in content.lower(), 'usage_id not found in sensor.py'
            print('✅ Energy sensor implementation verified')
        "
    
    - name: Test consumption in device handlers
      run: |
        cd custom_components/eedomus
        echo "Testing consumption monitoring in device handlers..."
        for device in switch.py light.py cover.py; do
            if [ -f "$device" ]; then
                if grep -qi "consumption" "$device"; then
                    echo "✅ Consumption monitoring found in $device"
                else
                    echo "⚠️  No consumption monitoring in $device"
                fi
            fi
        done
    
    - name: Verify test coverage
      run: |
        cd custom_components/eedomus
        echo "Verifying test coverage..."
        for test_file in tests/test_energy_sensor.py tests/test_switch.py tests/test_light.py tests/test_cover.py tests/test_sensor.py tests/test_integration.py; do
            if [ -f "$test_file" ]; then
                echo "✅ $test_file present"
            else
                echo "❌ $test_file missing"
                exit 1
            fi
        done